<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>KenKen</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;background:#1a1a2e;color:#e0e0e0;display:flex;flex-direction:column;align-items:center;justify-content:space-evenly;height:100vh;height:100dvh;padding:6px 8px;user-select:none}
h1{font-size:1.1rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:#e94560}
.topbar{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:400px}
.dbtn{display:flex;gap:5px}
.dbtn button{font-family:inherit;font-size:.6rem;font-weight:700;padding:4px 8px;border:none;border-radius:20px;background:#16213e;color:#888;cursor:pointer}
.dbtn button.on{background:#e94560;color:#fff}
.timer{font-family:monospace;font-size:.9rem;color:#aaa;font-weight:700}
.board{display:grid;gap:0;width:100%;max-width:340px;border:3px solid #e94560;border-radius:6px;overflow:hidden}
.cell{aspect-ratio:1;background:#16213e;border:1px solid #2a2a4a;display:flex;align-items:center;justify-content:center;font-size:clamp(1rem,5vw,1.5rem);font-weight:800;color:#4fc3f7;cursor:pointer;position:relative}
.cell.sel{background:rgba(233,69,96,.3)}
.cell.hl{background:rgba(15,52,96,.5)}
.cell .cage-label{position:absolute;top:1px;left:3px;font-size:clamp(.35rem,1.4vw,.5rem);color:#e94560;font-weight:700}
.cell.err{color:#ff5252}
.cell.bt{border-top:2px solid #e94560}
.cell.bb{border-bottom:2px solid #e94560}
.cell.bl{border-left:2px solid #e94560}
.cell.br{border-right:2px solid #e94560}
.numpad{display:flex;gap:3px;width:100%;max-width:340px;justify-content:center}
.numpad button{font-family:inherit;font-size:clamp(1rem,4.5vw,1.4rem);font-weight:800;flex:1;padding:10px 0;border:none;border-radius:8px;background:#16213e;color:#e0e0e0;min-width:0;cursor:pointer}
.numpad button:active{background:#e94560}
.actions{display:flex;gap:6px}
.actions button{font-family:inherit;font-size:.65rem;font-weight:700;padding:6px 12px;border:none;border-radius:16px;background:#16213e;color:#aaa;cursor:pointer}
.ov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(26,26,46,.93);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;z-index:10;visibility:hidden;opacity:0;transition:opacity .3s}
.ov.show{visibility:visible;opacity:1}
.ov h2{font-size:1.6rem;color:#e94560}
.ov p{color:#aaa;font-size:1rem}
.ov button{font-family:inherit;padding:12px 28px;border:none;border-radius:30px;background:#e94560;color:#fff;font-size:1rem;font-weight:700;cursor:pointer}
</style>
</head>
<body>
<h1>KENKEN</h1>
<div class="topbar">
  <div class="dbtn" id="db"><button data-d="4" class="on">4Ã—4</button><button data-d="5">5Ã—5</button><button data-d="6">6Ã—6</button></div>
  <span class="timer" id="tmr">00:00</span>
</div>
<div class="board" id="brd"></div>
<div class="numpad" id="np"></div>
<div class="actions"><button id="erase">âœ• Erase</button><button id="newBtn">â†» New</button></div>
<div class="ov" id="ov"><h2>ðŸŽ‰ Solved!</h2><p id="ovM"></p><button id="ovB">New Puzzle</button></div>
<script>
(function(){
var N=4,solution,userGrid,cages,selR=-1,selC=-1,tsec,tint,over;
var brdEl=document.getElementById('brd'),tmrEl=document.getElementById('tmr');
var ov=document.getElementById('ov'),ovM=document.getElementById('ovM');

function shuffle(a){for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=a[i];a[i]=a[j];a[j]=t;}return a;}

function genLatin(n){
  var g=[];
  for(var r=0;r<n;r++){g[r]=[];for(var c=0;c<n;c++)g[r][c]=((r+c)%n)+1;}
  // Shuffle rows
  var ri=[];for(var i=0;i<n;i++)ri.push(i);shuffle(ri);
  var g2=[];for(var i=0;i<n;i++)g2.push(g[ri[i]]);
  // Shuffle cols
  var ci=[];for(var i=0;i<n;i++)ci.push(i);shuffle(ci);
  var g3=[];for(var r=0;r<n;r++){g3[r]=[];for(var c=0;c<n;c++)g3[r][c]=g2[r][ci[c]];}
  return g3;
}

function genCages(n,sol){
  var used=[];for(var r=0;r<n;r++){used[r]=[];for(var c=0;c<n;c++)used[r][c]=false;}
  var cages=[],dirs=[[0,1],[1,0],[0,-1],[-1,0]];
  var cells=[];for(var r=0;r<n;r++)for(var c=0;c<n;c++)cells.push([r,c]);
  shuffle(cells);
  for(var i=0;i<cells.length;i++){
    var r=cells[i][0],c=cells[i][1];
    if(used[r][c])continue;
    var cage=[[r,c]];used[r][c]=true;
    var size=Math.random()<0.3?1:(Math.random()<0.6?2:3);
    if(size>1){
      shuffle(dirs);
      for(var d=0;d<dirs.length&&cage.length<size;d++){
        var nr=r+dirs[d][0],nc=c+dirs[d][1];
        if(nr>=0&&nr<n&&nc>=0&&nc<n&&!used[nr][nc]){cage.push([nr,nc]);used[nr][nc]=true;}
      }
      if(cage.length<size&&cage.length===2){
        var lr=cage[1][0],lc=cage[1][1];
        for(var d=0;d<dirs.length&&cage.length<size;d++){
          var nr=lr+dirs[d][0],nc=lc+dirs[d][1];
          if(nr>=0&&nr<n&&nc>=0&&nc<n&&!used[nr][nc]){cage.push([nr,nc]);used[nr][nc]=true;}
        }
      }
    }
    var vals=[];for(var j=0;j<cage.length;j++)vals.push(sol[cage[j][0]][cage[j][1]]);
    var op,target;
    if(cage.length===1){op='';target=vals[0];}
    else if(cage.length===2){
      var ops=['+','-','Ã—','Ã·'];
      var a=Math.max(vals[0],vals[1]),b=Math.min(vals[0],vals[1]);
      if(a%b===0&&Math.random()<0.3){op='Ã·';target=a/b;}
      else if(Math.random()<0.4){op='-';target=a-b;}
      else if(Math.random()<0.5){op='Ã—';target=vals[0]*vals[1];}
      else{op='+';target=vals[0]+vals[1];}
    }else{
      if(Math.random()<0.5){op='+';target=0;for(var j=0;j<vals.length;j++)target+=vals[j];}
      else{op='Ã—';target=1;for(var j=0;j<vals.length;j++)target*=vals[j];}
    }
    cages.push({cells:cage,op:op,target:target});
  }
  return cages;
}

function newGame(n){
  if(n)N=n;
  solution=genLatin(N);
  cages=genCages(N,solution);
  userGrid=[];for(var r=0;r<N;r++){userGrid[r]=[];for(var c=0;c<N;c++)userGrid[r][c]=0;}
  selR=0;selC=0;over=false;
  if(tint)clearInterval(tint);tsec=0;updT();
  tint=setInterval(function(){tsec++;updT();},1000);
  ov.className='ov';updD();buildNP();render();
}

function updD(){var bs=document.getElementById('db').children;for(var i=0;i<bs.length;i++)bs[i].className=parseInt(bs[i].getAttribute('data-d'))===N?'on':'';}
function updT(){var m=Math.floor(tsec/60),s=tsec%60;tmrEl.textContent=(m<10?'0':'')+m+':'+(s<10?'0':'')+s;}

function getCageIdx(r,c){for(var i=0;i<cages.length;i++){var cs=cages[i].cells;for(var j=0;j<cs.length;j++)if(cs[j][0]===r&&cs[j][1]===c)return i;}return-1;}

function render(){
  brdEl.innerHTML='';
  brdEl.style.gridTemplateColumns='repeat('+N+',1fr)';
  for(var r=0;r<N;r++){
    for(var c=0;c<N;c++){
      var d=document.createElement('div');d.className='cell';
      d.setAttribute('data-r',r);d.setAttribute('data-c',c);
      var ci=getCageIdx(r,c);
      // Cage borders
      if(ci>=0){
        var cage=cages[ci];
        var inCage=function(rr,cc){for(var k=0;k<cage.cells.length;k++)if(cage.cells[k][0]===rr&&cage.cells[k][1]===cc)return true;return false;};
        if(!inCage(r-1,c))d.classList.add('bt');
        if(!inCage(r+1,c))d.classList.add('bb');
        if(!inCage(r,c-1))d.classList.add('bl');
        if(!inCage(r,c+1))d.classList.add('br');
        // Label on first cell of cage
        if(cage.cells[0][0]===r&&cage.cells[0][1]===c){
          var lbl=document.createElement('span');lbl.className='cage-label';
          lbl.textContent=cage.target+(cage.op||'');d.appendChild(lbl);
        }
      }
      if(userGrid[r][c]>0){
        var s=document.createElement('span');s.textContent=userGrid[r][c];d.appendChild(s);
        // Check error: duplicate in row/col
        var err=false;
        for(var i=0;i<N;i++){if(i!==c&&userGrid[r][i]===userGrid[r][c])err=true;if(i!==r&&userGrid[i][c]===userGrid[r][c])err=true;}
        if(err)d.classList.add('err');
      }
      if(r===selR&&c===selC)d.classList.add('sel');
      else if(r===selR||c===selC)d.classList.add('hl');
      brdEl.appendChild(d);
    }
  }
}

function buildNP(){
  var np=document.getElementById('np');np.innerHTML='';
  for(var i=1;i<=N;i++){
    var b=document.createElement('button');b.textContent=i;
    b.addEventListener('click',(function(n){return function(){place(n);};})(i));
    np.appendChild(b);
  }
}

function place(n){
  if(over||selR<0)return;
  userGrid[selR][selC]=n;render();checkWin();
}

function checkWin(){
  for(var r=0;r<N;r++)for(var c=0;c<N;c++)if(userGrid[r][c]!==solution[r][c])return;
  over=true;clearInterval(tint);
  var m=Math.floor(tsec/60),s=tsec%60;
  ovM.textContent='Solved in '+m+'m '+(s<10?'0':'')+s+'s';
  setTimeout(function(){ov.className='ov show';},300);
}

brdEl.addEventListener('click',function(e){var t=e.target.closest('.cell');if(!t||over)return;selR=parseInt(t.getAttribute('data-r'));selC=parseInt(t.getAttribute('data-c'));render();});
document.getElementById('erase').addEventListener('click',function(){if(selR>=0){userGrid[selR][selC]=0;render();}});
document.getElementById('newBtn').addEventListener('click',function(){newGame();});
document.getElementById('ovB').addEventListener('click',function(){newGame();});
var dbs=document.getElementById('db').children;for(var i=0;i<dbs.length;i++){dbs[i].addEventListener('click',(function(b){return function(){newGame(parseInt(b.getAttribute('data-d')));};})(dbs[i]));}
document.addEventListener('keydown',function(e){if(over)return;var n=parseInt(e.key);if(n>=1&&n<=N)place(n);if(e.key==='Backspace'){if(selR>=0){userGrid[selR][selC]=0;render();}}if(e.key==='ArrowRight'&&selC<N-1){selC++;render();}if(e.key==='ArrowLeft'&&selC>0){selC--;render();}if(e.key==='ArrowDown'&&selR<N-1){selR++;render();}if(e.key==='ArrowUp'&&selR>0){selR--;render();}});
newGame();
})();
</script>
</body>
</html>
