<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
<title>Block Stack</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;background:#1a1a2e;color:#e0e0e0;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;height:100dvh;padding:4px;user-select:none;gap:4px}
h1{font-size:1rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:#e94560}
.topbar{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:380px}
.stats span{font-family:monospace;font-size:.75rem;font-weight:700;color:#aaa}
.sc{color:#4fc3f7!important}.lv{color:#e94560!important}
.game{display:flex;gap:6px;align-items:flex-start}
.brd{border:3px solid #e94560;border-radius:4px;display:block;background:#0f0f23}
.side{display:flex;flex-direction:column;gap:6px}
.nxt{border:2px solid #2a2a4a;border-radius:4px;background:#0f0f23;display:block}
.nl{font-size:.45rem;color:#888;text-align:center}
.ctrl{display:grid;grid-template-columns:repeat(3,36px);gap:3px}
.ctrl button{width:36px;height:36px;border:none;border-radius:8px;background:#16213e;color:#e0e0e0;font-size:.9rem;font-weight:800;cursor:pointer}
.ctrl button:active{background:#e94560}
.dbtn{width:100%;padding:8px;border:none;border-radius:8px;background:#e94560;color:#fff;font-family:inherit;font-size:.7rem;font-weight:700;cursor:pointer}
</style>
</head>
<body>
<h1>BLOCK STACK</h1>
<div class="topbar">
  <span class="stats"><span class="sc" id="sc">Score: 0</span></span>
  <span class="stats"><span class="lv" id="lv">Lv 1</span> <span id="ln">Lines: 0</span></span>
</div>
<div class="game">
  <canvas class="brd" id="brd"></canvas>
  <div class="side">
    <div class="nl">NEXT</div>
    <canvas class="nxt" id="nxt" width="72" height="72"></canvas>
    <div class="ctrl">
      <div></div><button id="bU">↻</button><div></div>
      <button id="bL">◀</button><button id="bD">▼</button><button id="bR">▶</button>
    </div>
    <button class="dbtn" id="bDr">⬇ DROP</button>
  </div>
</div>
<script>
(function(){
var COLS=10,ROWS=20,CS,brd=document.getElementById('brd'),ctx=brd.getContext('2d');
var nxt=document.getElementById('nxt'),nctx=nxt.getContext('2d');
var SHAPES=[
  {s:[[1,1,1,1]],c:'#4fc3f7'},
  {s:[[1,1],[1,1]],c:'#ffca28'},
  {s:[[0,1,0],[1,1,1]],c:'#ab47bc'},
  {s:[[1,0],[1,0],[1,1]],c:'#ff7043'},
  {s:[[0,1],[0,1],[1,1]],c:'#4fc3f7'},
  {s:[[0,1,1],[1,1,0]],c:'#66bb6a'},
  {s:[[1,1,0],[0,1,1]],c:'#e94560'}
];
var grid,cur,cx,cy,next,score,lines,level,dropMs,tid,state;

function sz(){
  var maxH=window.innerHeight*.58;
  CS=Math.floor(Math.min(maxH/ROWS,(window.innerWidth*.55)/COLS));
  CS=Math.max(CS,14);CS=Math.min(CS,24);
  brd.width=COLS*CS;brd.height=ROWS*CS;
}

function rp(){return JSON.parse(JSON.stringify(SHAPES[Math.floor(Math.random()*SHAPES.length)]));}
function shuf(a){for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=a[i];a[i]=a[j];a[j]=t;}}

function newGame(){
  sz();grid=[];
  for(var r=0;r<ROWS;r++){grid[r]=[];for(var c=0;c<COLS;c++)grid[r][c]=0;}
  score=0;lines=0;level=1;dropMs=700;state='play';
  next=rp();spawn();
  if(tid)clearInterval(tid);
  tid=setInterval(tick,dropMs);
  draw();
}

function spawn(){
  cur=next;next=rp();
  cx=Math.floor((COLS-cur.s[0].length)/2);cy=0;
  if(!fits(cur.s,cx,cy)){state='over';clearInterval(tid);}
  drawNext();
}

function fits(s,x,y){
  for(var r=0;r<s.length;r++)for(var c=0;c<s[r].length;c++){
    if(!s[r][c])continue;
    var nr=y+r,nc=x+c;
    if(nc<0||nc>=COLS||nr>=ROWS)return false;
    if(nr>=0&&grid[nr][nc])return false;
  }
  return true;
}

function lock(){
  for(var r=0;r<cur.s.length;r++)for(var c=0;c<cur.s[r].length;c++){
    if(!cur.s[r][c])continue;
    var nr=cy+r;if(nr<0)continue;
    grid[nr][cx+c]=cur.c;
  }
  clearLines();spawn();
}

function clearLines(){
  var cl=0;
  for(var r=ROWS-1;r>=0;r--){
    var full=true;for(var c=0;c<COLS;c++)if(!grid[r][c])full=false;
    if(full){grid.splice(r,1);var row=[];for(var c=0;c<COLS;c++)row.push(0);grid.unshift(row);cl++;r++;}
  }
  if(cl){
    score+=[0,100,300,500,800][cl]*level;lines+=cl;
    level=Math.floor(lines/10)+1;
    dropMs=Math.max(80,700-level*55);
    clearInterval(tid);tid=setInterval(tick,dropMs);
    updHUD();
  }
}

function rotate(){
  var s=cur.s,rows=s.length,cols=s[0].length;
  var ns=[];for(var c=0;c<cols;c++){ns[c]=[];for(var r=rows-1;r>=0;r--)ns[c].push(s[r][c]);}
  for(var dx=0;dx<=1;dx++){
    if(fits(ns,cx+dx,cy)){cur.s=ns;cx+=dx;return;}
    if(fits(ns,cx-dx,cy)){cur.s=ns;cx-=dx;return;}
  }
}

function moveX(d){if(fits(cur.s,cx+d,cy))cx+=d;}
function softDrop(){if(fits(cur.s,cx,cy+1))cy++;else lock();}
function hardDrop(){while(fits(cur.s,cx,cy+1))cy++;lock();}
function tick(){if(state==='play'){softDrop();draw();}}

function updHUD(){
  document.getElementById('sc').textContent='Score: '+score;
  document.getElementById('lv').textContent='Lv '+level;
  document.getElementById('ln').textContent='Lines: '+lines;
}

function draw(){
  sz();ctx.fillStyle='#0f0f23';ctx.fillRect(0,0,brd.width,brd.height);
  // Grid lines
  ctx.strokeStyle='rgba(255,255,255,.03)';ctx.lineWidth=1;
  for(var r=1;r<ROWS;r++){ctx.beginPath();ctx.moveTo(0,r*CS);ctx.lineTo(brd.width,r*CS);ctx.stroke();}
  for(var c=1;c<COLS;c++){ctx.beginPath();ctx.moveTo(c*CS,0);ctx.lineTo(c*CS,brd.height);ctx.stroke();}
  // Locked pieces
  for(var r=0;r<ROWS;r++)for(var c=0;c<COLS;c++){
    if(grid[r][c]){ctx.fillStyle=grid[r][c];ctx.fillRect(c*CS+1,r*CS+1,CS-2,CS-2);}
  }
  if(state==='play'){
    // Ghost
    var gy=cy;while(fits(cur.s,cx,gy+1))gy++;
    ctx.globalAlpha=.15;
    for(var r=0;r<cur.s.length;r++)for(var c=0;c<cur.s[r].length;c++){
      if(cur.s[r][c])ctx.fillStyle=cur.c,ctx.fillRect((cx+c)*CS+1,(gy+r)*CS+1,CS-2,CS-2);
    }
    ctx.globalAlpha=1;
    // Current piece
    for(var r=0;r<cur.s.length;r++)for(var c=0;c<cur.s[r].length;c++){
      if(cur.s[r][c]&&cy+r>=0){ctx.fillStyle=cur.c;ctx.fillRect((cx+c)*CS+1,(cy+r)*CS+1,CS-2,CS-2);}
    }
  }
  // Overlays
  if(state==='menu'||state==='over'){
    ctx.fillStyle='rgba(10,10,30,.85)';ctx.fillRect(0,brd.height*.3,brd.width,brd.height*.35);
    ctx.textAlign='center';ctx.fillStyle='#e94560';
    ctx.font='bold '+Math.floor(brd.width*.07)+'px sans-serif';
    ctx.fillText(state==='over'?'GAME OVER':'BLOCK STACK',brd.width/2,brd.height*.45);
    ctx.fillStyle='#aaa';ctx.font=Math.floor(brd.width*.04)+'px sans-serif';
    ctx.fillText(state==='over'?'Score: '+score+' · Tap to restart':'Tap to play!',brd.width/2,brd.height*.55);
  }
  updHUD();
}

function drawNext(){
  nctx.fillStyle='#0f0f23';nctx.fillRect(0,0,72,72);
  if(!next)return;
  var s=next.s,ns=14;
  var ox=(72-s[0].length*ns)/2,oy=(72-s.length*ns)/2;
  for(var r=0;r<s.length;r++)for(var c=0;c<s[r].length;c++){
    if(s[r][c]){nctx.fillStyle=next.c;nctx.fillRect(ox+c*ns+1,oy+r*ns+1,ns-2,ns-2);}
  }
}

// Controls
function handleAction(action){
  if(state==='menu'||state==='over'){newGame();return;}
  if(state!=='play')return;
  switch(action){
    case'left':moveX(-1);break;case'right':moveX(1);break;
    case'down':softDrop();break;case'rotate':rotate();break;
    case'drop':hardDrop();break;
  }
  draw();
}

document.getElementById('bL').addEventListener('click',function(){handleAction('left');});
document.getElementById('bR').addEventListener('click',function(){handleAction('right');});
document.getElementById('bD').addEventListener('click',function(){handleAction('down');});
document.getElementById('bU').addEventListener('click',function(){handleAction('rotate');});
document.getElementById('bDr').addEventListener('click',function(){handleAction('drop');});

document.addEventListener('keydown',function(e){
  if(state==='menu'||state==='over'){if(e.key)newGame();return;}
  switch(e.key){
    case'ArrowLeft':handleAction('left');break;case'ArrowRight':handleAction('right');break;
    case'ArrowDown':handleAction('down');break;case'ArrowUp':handleAction('rotate');break;
    case' ':e.preventDefault();handleAction('drop');break;
  }
});

// Swipe on board
var sx=0,sy=0;
brd.addEventListener('touchstart',function(e){var t=e.touches[0];sx=t.clientX;sy=t.clientY;e.preventDefault();},{passive:false});
brd.addEventListener('touchend',function(e){
  var t=e.changedTouches[0],dx=t.clientX-sx,dy=t.clientY-sy;
  var ax=Math.abs(dx),ay=Math.abs(dy);
  if(ax<12&&ay<12){handleAction('rotate');}
  else if(ay>ax&&dy>25){handleAction('drop');}
  else if(ax>ay&&ax>15){handleAction(dx>0?'right':'left');}
},{passive:true});

// Canvas tap to start
brd.addEventListener('click',function(){
  if(state==='menu'||state==='over')newGame();
});

// Init menu
// Init menu
sz();
state = 'menu';

score = 0;
lines = 0;
level = 1;
dropMs = 700;

grid = [];
for(var r=0;r<ROWS;r++){
  grid[r]=[];
  for(var c=0;c<COLS;c++) grid[r][c]=0;
}

updHUD();   // <-- important
draw();

})();
</script>
</body>
</html>
